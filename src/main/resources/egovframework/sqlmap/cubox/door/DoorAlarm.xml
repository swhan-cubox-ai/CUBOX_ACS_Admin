<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="door.alarm">

    <select id="selectDoorAlarmGrpList"  parameterType="HashMap" resultType="HashMap">
        SELECT
        dg.id
        , dg.nm
        , dg.env_yn
        , dg.time
        , d.cnt
        , DATE_FORMAT(dg.created_at, '%Y-%m-%d') as created_at
        , DATE_FORMAT(dg.updated_at, '%Y-%m-%d') as created_at
        FROM T_DOORALARM_GRP dg
        LEFT OUTER JOIN (
        SELECT dooralarm_grp_id, count(dooralarm_grp_id) as cnt FROM T_DOOR GROUP BY dooralarm_grp_id) d
        ON dg.id = d.dooralarm_grp_id
        WHERE 1=1
         <if test='@aero.cubox.util.CommonUtils@notEmpty(keyword)'>
             AND dg.nm like CONCAT('%',#{keyword},'%')
         </if>
        ORDER BY created_at DESC
         <if test='@aero.cubox.util.CommonUtils@notEmpty(offset)'>
        LIMIT #{srchCnt} OFFSET #{offset}
         </if>
    </select>


    <select id="selectDoorAlarmGrpListCount"  parameterType="HashMap" resultType="int">
        SELECT
            count(*)
        FROM T_DOORALARM_GRP dg
             LEFT OUTER JOIN (
        SELECT dooralarm_grp_id, count(dooralarm_grp_id) as cnt FROM T_DOOR GROUP BY dooralarm_grp_id) d
             ON dg.id = d.dooralarm_grp_id
        WHERE 1=1
        <if test='@aero.cubox.util.CommonUtils@notEmpty(keyword)'>
            AND dg.nm like CONCAT('%',#{keyword},'%')
        </if>
    </select>


    <select id="selectDoorAlarmGrpDetail"  parameterType="int" resultType="HashMap">
        SELECT TDG.id
             , TDG.nm
             , TDG.time
             , TDG.env_yn
             , COUNT(TD.id) AS door_cnt
             , GROUP_CONCAT( TD.id  SEPARATOR '/')  AS door_ids
             , GROUP_CONCAT( TD.door_nm  SEPARATOR '/') AS door_nms
             , DATE_FORMAT(TDG.created_at, '%Y-%m-%d') as created_at
             , DATE_FORMAT(TDG.updated_at, '%Y-%m-%d') as updated_at
        FROM T_DOORALARM_GRP TDG
                 LEFT OUTER JOIN T_DOOR TD ON TDG.id = TD.dooralarm_grp_id
        GROUP BY  TDG.id
         HAVING 1=1
           AND TDG.id = #{id}
    </select>


    <insert id="insertDoorAlarmGrp" parameterType="HashMap" useGeneratedKeys="true" keyProperty="doorAlarmGrpId" keyColumn="id">
        INSERT
          INTO T_DOORALARM_GRP
             ( nm
             , time
             , env_yn
             , created_at
             , updated_at
             )
        VALUES
             ( #{nm}
             , #{time}
             , #{envYn}
             , NOW()
             , NOW()
             )

    </insert>


    <update id="updateDoorAlarmGrp" parameterType="HashMap">
        UPDATE T_DOORALARM_GRP
           SET nm = #{nm}
             , time = #{time}
             , env_yn = #{envYn}
             , updated_at= NOW()
         WHERE id = #{id}
    </update>


    <delete id="deleteDoorAlarmGrp" parameterType="int" >
        DELETE
          FROM T_DOORALARM_GRP
         WHERE id = #{id}
    </delete>


    <update id="updateDoorAlarmGroupId" parameterType="HashMap">
        UPDATE T_DOOR
        SET dooralarm_grp_id = #{dooralarm_grp_id}
        WHERE id = #{doorId}
    </update>

    <update id="deleteDoorAlarmGrpDoor" parameterType="int">
        UPDATE T_DOOR
        SET dooralarm_grp_id = null
        WHERE dooralarm_grp_id = #{id}
    </update>


    <select id="selectDoorAlarmGrpNameVerification" parameterType="HashMap" resultType="int">
        SELECT COUNT(TDG.id) AS vCnt
          FROM T_DOORALARM_GRP TDG
         WHERE 1 = 1
           AND replace(TDG.nm, ' ', '') = replace(#{nm}, ' ', '')
    </select>


</mapper>